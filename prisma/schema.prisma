generator client {
  provider = "prisma-client"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum PlanId {
  free
  starter
  pro
}

enum SubscriptionStatus {
  active
  cancelled
  past_due
  trialing
  on_hold    // Dodo: payment failed, grace period running
  renewed
}

// ─── User ─────────────────────────────────────────────────────────────────────

model User {
  id            String   @id @default(cuid())
  username      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  email         String   @unique
  password      String
  dailyGoal     Int      @default(5)
  twitterHandle String?
  openaiKey     String?

  // Relations
  aiUsage    AIUsage[]
  analytics  Analytics[]
  dailyStats DailyStats[]
  replies    Reply[]
  streak     Streak?

  // Billing
  subscription Subscription?
  dailyUsage   DailyUsage[]
  payments     Payment[]

  @@index([email])
}

// ─── Reply ────────────────────────────────────────────────────────────────────

model Reply {
  id          String   @id @default(cuid())
  userId      String
  tweetId     String?
  tweetText   String
  replyText   String
  tone        String   @default("smart")
  posted      Boolean  @default(false)
  impressions Int      @default(0)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// ─── DailyStats ───────────────────────────────────────────────────────────────

model DailyStats {
  id                   String   @id @default(cuid())
  userId               String
  date                 DateTime @default(now())
  repliesGenerated     Int      @default(0)
  repliesPosted        Int      @default(0)
  goalCompleted        Boolean  @default(false)
  engagementScore      Float    @default(0)
  estimatedImpressions Int      @default(0)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
}

// ─── Streak ───────────────────────────────────────────────────────────────────

model Streak {
  id             String    @id @default(cuid())
  userId         String    @unique
  current        Int       @default(0)
  longest        Int       @default(0)
  lastActiveDate DateTime?
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── Analytics ────────────────────────────────────────────────────────────────

model Analytics {
  id                   String   @id @default(cuid())
  userId               String
  period               String
  periodStart          DateTime
  totalReplies         Int      @default(0)
  avgRepliesPerDay     Float    @default(0)
  consistencyScore     Float    @default(0)
  growthRating         String   @default("Beginner")
  estimatedImpressions Int      @default(0)
  createdAt            DateTime @default(now())
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, period])
}

// ─── AIUsage ──────────────────────────────────────────────────────────────────

model AIUsage {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  tokens    Int      @default(0)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ─── Subscription ─────────────────────────────────────────────────────────────
// Mirrors Dodo Payments subscription lifecycle.
//
// IDs:
//   dodoCustomerId     → "cus_xxx"  — created on first checkout / webhook
//   dodoSubscriptionId → "sub_xxx"  — set on subscription.active webhook
//   dodoProductId      → "pdt_xxx"  — the plan's product in Dodo dashboard

model Subscription {
  id     String @id @default(cuid())
  userId String @unique

  planId PlanId             @default(free)
  status SubscriptionStatus @default(active)

  // Dodo Payments identifiers
  dodoCustomerId     String? @unique
  dodoSubscriptionId String? @unique
  dodoProductId      String?

  // Billing period — populated from webhook payload
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  // Grace period end (when status = on_hold, give N days before revoking access)
  gracePeriodEnds DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dodoCustomerId])
  @@index([dodoSubscriptionId])
}

// ─── DailyUsage ───────────────────────────────────────────────────────────────

model DailyUsage {
  id     String @id @default(cuid())
  userId String

  date String // "YYYY-MM-DD" UTC

  repliesCount Int @default(0)
  tweetsCount  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ─── Payment ─────────────────────────────────────────────────────────────────
// Audit log of Dodo Payments events (charges, renewals, refunds).

model Payment {
  id     String @id @default(cuid())
  userId String

  planId   PlanId
  amount   Float  // USD
  currency String @default("usd")

  // "succeeded" | "failed" | "refunded" | "pending"
  status String

  provider String @default("dodo_payments")

  // Dodo-specific IDs (from webhook payload)
  dodoPaymentId String? // pay_xxx
  dodoInvoiceId String? // inv_xxx

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([dodoPaymentId])
}
