generator client {
  provider = "prisma-client"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// â”€â”€â”€ Enums â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum PlanId {
  free
  starter
  pro
}

enum SubscriptionStatus {
  active
  cancelled
  past_due
  trialing
  on_hold    // Dodo: payment failed, grace period running
  renewed
}

// â”€â”€â”€ User â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model User {
  id            String   @id @default(cuid())
  username      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  email         String   @unique
  password      String
  dailyGoal     Int      @default(5)
  twitterHandle String?
  openaiKey     String?

  // Relations
  aiUsage    AIUsage[]
  analytics  Analytics[]
  dailyStats DailyStats[]
  replies    Reply[]
  streak     Streak?

  // Billing
  subscription Subscription?
  dailyUsage   DailyUsage[]
  payments     Payment[]

  @@index([email])
}

// â”€â”€â”€ Reply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Reply {
  id          String   @id @default(cuid())
  userId      String
  tweetId     String?
  tweetText   String
  replyText   String
  tone        String   @default("smart")
  posted      Boolean  @default(false)
  impressions Int      @default(0)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// â”€â”€â”€ DailyStats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model DailyStats {
  id                   String   @id @default(cuid())
  userId               String
  date                 DateTime @default(now())
  repliesGenerated     Int      @default(0)
  repliesPosted        Int      @default(0)
  goalCompleted        Boolean  @default(false)
  engagementScore      Float    @default(0)
  estimatedImpressions Int      @default(0)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
}

// â”€â”€â”€ Streak â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Streak {
  id             String    @id @default(cuid())
  userId         String    @unique
  current        Int       @default(0)
  longest        Int       @default(0)
  lastActiveDate DateTime?
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// â”€â”€â”€ Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Analytics {
  id                   String   @id @default(cuid())
  userId               String
  period               String
  periodStart          DateTime
  totalReplies         Int      @default(0)
  avgRepliesPerDay     Float    @default(0)
  consistencyScore     Float    @default(0)
  growthRating         String   @default("Beginner")
  estimatedImpressions Int      @default(0)
  createdAt            DateTime @default(now())
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, period])
}

// â”€â”€â”€ AIUsage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model AIUsage {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  tokens    Int      @default(0)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// â”€â”€â”€ Subscription â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Mirrors Dodo Payments subscription lifecycle.
//
// IDs:
//   dodoCustomerId     â†’ "cus_xxx"  â€” created on first checkout / webhook
//   dodoSubscriptionId â†’ "sub_xxx"  â€” set on subscription.active webhook
//   dodoProductId      â†’ "pdt_xxx"  â€” the plan's product in Dodo dashboard

model Subscription {
  id     String @id @default(cuid())
  userId String @unique

  planId PlanId             @default(free)
  status SubscriptionStatus @default(active)

  // Dodo Payments identifiers
  dodoCustomerId     String? @unique
  dodoSubscriptionId String? @unique
  dodoProductId      String?

  // Billing period â€” populated from webhook payload
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)

  // Grace period end (when status = on_hold, give N days before revoking access)
  gracePeriodEnds DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dodoCustomerId])
  @@index([dodoSubscriptionId])
}

// â”€â”€â”€ DailyUsage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model DailyUsage {
  id     String @id @default(cuid())
  userId String

  date String // "YYYY-MM-DD" UTC

  repliesCount Int @default(0)
  tweetsCount  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// â”€â”€â”€ Payment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Audit log of Dodo Payments events (charges, renewals, refunds).

model Payment {
  id     String @id @default(cuid())
  userId String

  planId   PlanId
  amount   Float  // USD
  currency String @default("usd")

  // "succeeded" | "failed" | "refunded" | "pending"
  status String

  provider String @default("dodo_payments")

  // Dodo-specific IDs (from webhook payload)
  dodoPaymentId String? // pay_xxx
  dodoInvoiceId String? // inv_xxx

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([dodoPaymentId])
}

// â”€â”€â”€ PromptTemplate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Admin-managed tweet/reply templates.
model PromptTemplate {
  id          String   @id @default(cuid())
  slug        String   @unique
  label       String
  emoji       String   @default("ðŸ§©")
  instruction String
  structure   String?
  example     String?
  category    String   @default("general")
  target      String   @default("both") // tweet | reply | both
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, sortOrder])
  @@index([target])
}

// â”€â”€â”€ PromptConfig â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Admin-managed instruction blocks used by AI generators/modules.
model PromptConfig {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

// â”€â”€â”€ ModuleConfig â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Admin-managed module visibility and copy overrides.
model ModuleConfig {
  id           String   @id // matches FeatureId
  name         String?
  description  String?
  availability String?
  minimumPlan  PlanId?
  isVisible    Boolean  @default(true)
  promptHint   String?
  inputHelp    Json?
  examples     Json?
  updatedAt    DateTime @updatedAt
}
